name: Delete hetzner-k3s cluster

on:
  workflow_dispatch:
    inputs:
      name:
        type: string
        default: ""
        description: Name of the cluster

jobs:
  destroy:
    runs-on: ubuntu-latest
    permissions: 
      id-token: write
      contents: read
    steps:
    - uses: actions/checkout@v3
    - name: Fetch secrets from AKeyless
      id: fetch-secrets
      uses: LanceMcCarthy/akeyless-action@v3
      with:
        access-id: ${{ secrets.AKEYLESS_ACCESS_ID}}
        static-secrets: '{"/alleaffengaffen/actions/grapes/hcloud_token":"HCLOUD_TOKEN"}'
    - name: Setup hetzner-k3s cli
      run: |
        curl -fsSL -o /tmp/hetzner-k3s-linux-amd64 https://github.com/vitobotta/hetzner-k3s/releases/latest/download/hetzner-k3s-linux-amd64
        sudo install -m 555 /tmp/hetzner-k3s-linux-amd64 /usr/local/bin/hetzner-k3s
        hetzner-k3s --version
    - name: Download outputs
      id: download-artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: create-hetzner-k3s.yml
        branch: main
        name: outputs-${{ github.event.inputs.name }}
        path: output
        search_artifacts: true
    - name: Delete cluster
      run: hetzner-k3s delete --config output/cluster-config.yaml